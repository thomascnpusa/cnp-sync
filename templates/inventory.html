<!DOCTYPE html>
<html>
<head>
    <title>Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .excel-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; }
        .excel-table th, .excel-table td { border: 1px solid #e0e0e0; padding: 6px; text-align: left; }
        .excel-table th { background: #f5f7fa; font-weight: bold; }
        .excel-table th a { text-decoration: none; color: #333; }
        .excel-table tr:hover { background: #f9f9f9; }
        .excel-table a { color: #007bff; text-decoration: none; }
        .excel-table a:hover { text-decoration: underline; }
        .low-stock { background-color: #ffe6e6; }
        .expiring { background-color: #fff3e6; }
        .filter-form { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .filter-form input, .filter-form select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .pagination { margin-top: 20px; display: flex; gap: 10px; align-items: center; }
        .batch-details { font-size: 0.85em; color: #666; margin-top: 4px; display: none; }
        .batch-toggle { cursor: pointer; color: #007bff; font-size: 0.9em; }
        .batch-toggle:hover { text-decoration: underline; }
        .adjust-link { font-size: 0.85em; margin-left: 5px; }
    </style>
    <script>
        function toggleBatchDetails(id) {
            var details = document.getElementById('batch-' + id);
            if (details.style.display === 'block') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
            }
        }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="/">Home</a>
        <a href="/sync">Sync</a>
        <a href="/inventory">Inventory</a>
        <a href="/receive">Receive</a>
        <a href="/produce">Produce</a>
        <a href="/fulfill">Fulfill Orders</a>
        <a href="/adjust">Adjust</a>
        <a href="/sales">Sales</a>
        <a href="/manual-sale">Manual Sale</a>
        <a href="/history">Order History</a>
    </div>
    <div class="container">
        <h1>Inventory Report (Last {{ lookback_days }} Days)</h1>
        <form method="GET" class="filter-form">
            <input type="text" name="search" value="{{ search_query }}" placeholder="Search by ID, Name, or Batch" class="form-control">
            <select name="sellable">
                <option value="all" {% if sellable_filter == 'all' %}selected{% endif %}>All Items</option>
                <option value="sellable" {% if sellable_filter == 'sellable' %}selected{% endif %}>Sellable</option>
                <option value="non-sellable" {% if sellable_filter == 'non-sellable' %}selected{% endif %}>Non-Sellable</option>
            </select>
            <button type="submit" class="btn">Filter</button>
            <a href="{{ url_for('main.inventory', page=pagination.page, search=search_query, sellable=sellable_filter, sort=sort_by, order=sort_order, export='true') }}" class="btn">Export CSV</a>
        </form>
        <table class="excel-table">
            <thead>
                <tr>
                    <th><a href="{{ url_for('main.inventory', page=pagination.page, search=search_query, sellable=sellable_filter, sort='product_id', order='desc' if sort_by == 'product_id' and sort_order == 'asc' else 'asc') }}">Product ID</a></th>
                    <th>Name</th>
                    <th>Location</th>
                    <th><a href="{{ url_for('main.inventory', page=pagination.page, search=search_query, sellable=sellable_filter, sort='quantity', order='desc' if sort_by == 'quantity' and sort_order == 'asc' else 'asc') }}">Quantity</a></th>
                    <th>Min Qty</th>
                    <th>Batch Number</th>
                    <th><a href="{{ url_for('main.inventory', page=pagination.page, search=search_query, sellable=sellable_filter, sort='expiry_date', order='desc' if sort_by == 'expiry_date' and sort_order == 'asc' else 'asc') }}">Expiry Date</a></th>
                    <th>Sellable</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventory %}
                    <tr {% if item.quantity < item.minimum_quantity or item.quantity < 100 %}class="low-stock"{% elif item.expiry_date and item.expiry_date < expiry_threshold %}class="expiring"{% endif %}>
                        <td><a href="{{ url_for('main.product_detail', product_id=item.product_id) }}">{{ item.product_id }}</a></td>
                        <td><a href="{{ url_for('main.product_detail', product_id=item.product_id) }}">{{ item.product.product_name }}</a></td>
                        <td>{{ item.location }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.minimum_quantity }}</td>
                        <td>
                            {{ item.batch_number or 'N/A' }}
                            {% if batch_history[item.inventory_id] %}
                                <span class="batch-toggle" onclick="toggleBatchDetails('{{ item.inventory_id }}')"> [+] Details</span>
                                <div id="batch-{{ item.inventory_id }}" class="batch-details">
                                    {% for history in batch_history[item.inventory_id] %}
                                        <div>{{ history.batch }}: Order {{ history.order_id }} ({{ history.quantity }} {{ history.product_id }}, {{ history.status }}, {{ history.date }})</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </td>
                        <td>{{ item.expiry_date or 'N/A' }}</td>
                        <td>{{ 'Yes' if item.product.sellable else 'No' }}</td>
                        <td><a href="{{ url_for('main.adjust', product_id=item.product_id) }}" class="adjust-link">Adjust</a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination">
            {% if pagination.has_prev %}
                <a href="{{ url_for('main.inventory', page=pagination.page-1, search=search_query, sellable=sellable_filter, sort=sort_by, order=sort_order) }}" class="btn">Previous</a>
            {% endif %}
            <span>Page {{ pagination.page }} of {{ pagination.pages }}</span>
            {% if pagination.has_next %}
                <a href="{{ url_for('main.inventory', page=pagination.page+1, search=search_query, sellable=sellable_filter, sort=sort_by, order=sort_order) }}" class="btn">Next</a>
            {% endif %}
        </div>
        {% if low_inventory %}
            <h2>Low Inventory Alerts</h2>
            <ul>
                {% for item in low_inventory %}
                    <li>{{ item.product.product_name }} ({{ item.product_id }}) at {{ item.location }}: {{ item.quantity }} (Min: {{ item.minimum_quantity }})</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>
</body>
</html>